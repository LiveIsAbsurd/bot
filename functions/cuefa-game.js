const token = require("../../token.js");

const TelegramBot = require("node-telegram-bot-api");
const fs = require("fs");

const bot = new TelegramBot(token);

let cuefaPlayer1Id = {};
let cuefaPlayer2Id = {};
let cuefaPlayers = {};
let cuefaColl = {};
let cuefaToEmoji = {
  rock: "ü§ú",
  nosh: "‚úåÔ∏è",
  paper: "‚úã",
};
const cuefaKeyboard = {
  inline_keyboard: [
    [
      { text: "ü§ú", callback_data: "rock" },
      { text: "‚úåÔ∏è", callback_data: "nosh" },
      { text: "‚úã", callback_data: "paper" },
    ],
  ],
};

function setCuefaStats(winer, winerName, loser, loserName, noWin = false, getCuefaStats) {
    fs.readFile("../../cuefaStats.json", "UTF-8", (err, data) => {
      let stats = JSON.parse(data);
  
      if (!Object.keys(stats).includes(winer)) {
        if (!noWin) {
            stats[winer] = {
                total: 1,
                win: 1,
                lose: 0,
                vs: {},
            }
  
            stats[winer].name = winerName;
            stats[winer].vs[loser] = [1, 0, 0];
        } else {
            stats[winer] = {
                total: 1,
                win: 0,
                lose: 0,
                vs: {},
            }
  
            stats[winer].name = winerName;
            stats[winer].vs[loser] = [0, 0, 1];
        }
      } else {
  
        if (stats[winer].name != winerName) {
          stats[winer].name = winerName;
        }
  
        stats[winer].total += 1;
  
        if (!noWin) {
            stats[winer].win += 1;
  
            if(!Object.keys(stats[winer].vs).includes(loser)) {
                stats[winer].vs[loser] = [1, 0, 0]
            } else {
                stats[winer].vs[loser][0] += 1;
            }
        } else {
            if(!Object.keys(stats[winer].vs).includes(loser)) {
                stats[winer].vs[loser] = [0, 0, 1]
            } else {
                stats[winer].vs[loser][2] += 1;
            }
        }
      }
  
      if (!Object.keys(stats).includes(loser)) {
        if (!noWin) {
            stats[loser] = {
                total: 1,
                win: 0,
                lose: 1,
                vs: {},
            }
  
            stats[loser].name = loserName;
            stats[loser].vs[winer] = [0, 1, 0];
        } else {
            stats[loser] = {
                total: 1,
                win: 0,
                lose: 0,
                vs: {},
            }
  
            stats[loser].name = loserName;
            stats[loser].vs[winer] = [0, 0, 1];
        }
      } else {
  
        if (stats[loser].name != loserName) {
          stats[loser].name = loserName;
        }
  
        stats[loser].total += 1;
  
        if (!noWin) {
            stats[loser].lose += 1;
  
            if(!Object.keys(stats[loser].vs).includes(winer)) {
                stats[loser].vs[winer] = [0, 1, 0]
            } else {
                stats[loser].vs[winer][1] += 1;
            }
        } else {
            if(!Object.keys(stats[loser].vs).includes(winer)) {
                stats[loser].vs[winer] = [0, 0, 1]
            } else {
                stats[loser].vs[winer][2] += 1;
            }
        }
      }
  
      fs.writeFile("../../cuefaStats.json", JSON.stringify(stats), "UTF-8", (err) => {
        if (err) {
          console.log(err);
        }
  
        getCuefaStats();
      });
    })
  }
  
  function cuefaGame(msg = null, query = null, replay = false, isMeme = false) {
    if (msg || replay) {
      const player1 = {};
      player1[replay ? query.from.username : msg.from.username] = { select: undefined };
  
      const player2 = {};
      if (replay) {
        player2["undefined"] = { select: undefined };
      } else {
        player2[msg.reply_to_message ? msg.reply_to_message.from.username : undefined] = { select: undefined };
      }
  
      const player1Name = Object.keys(player1)[0];
      const player2Name =
        Object.keys(player2)[0] != "undefined" ? `@${Object.keys(player2)[0]}` : "(–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞...)";
  
      if (player1Name == player2Name.replace("@", "")) {
        bot.sendMessage(msg.chat.id, "–•–æ—á–µ—à—å –∏–≥—Ä–∞—Ç—å —Å —Å–∞–º–∏–º —Å–æ–±–æ–π?");
        return;
      }
      
      chatId = replay ? query.message.chat.id : msg.chat.id;
  
      bot.sendMessage(
          chatId,
          `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
@${player1Name} üÜö ${player2Name}
${isMeme ? "" : `–≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–≥—Ä—ã, 
–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤ meme_house_chat.t.me`}`,
          { reply_markup: cuefaKeyboard }
        )
        .then((msg) => {
          cuefaColl[msg.message_id] = {};
          cuefaColl[msg.message_id].steps = {
            player1Step: false,
            player2Step: false,
          };
          cuefaColl[msg.message_id]["player1"] = player1;
          cuefaColl[msg.message_id]["player2"] = player2;
          cuefaPlayers[msg.message_id] = [
            Object.keys(cuefaColl[msg.message_id].player1)[0],
            Object.keys(cuefaColl[msg.message_id].player2)[0],
          ];
        });
    } else if (query && !replay) {
  
      if (!cuefaColl[query.message.message_id]) {
        bot.editMessageText(
          "–í—Ä–µ–º—è –≤—ã—à–ª–æ!",
          {
            chat_id: query.message.chat.id,
            message_id:query.message.message_id
          }
        );
        return;
      }
  
      const player2Name =
        cuefaPlayers[query.message.message_id][1] != "undefined" ? `@${cuefaPlayers[query.message.message_id][1]}` : "(–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞...)";
  
      if (cuefaPlayers[query.message.message_id][0] == query.from.username) {
        if (!cuefaColl[query.message.message_id].steps.player1Step && cuefaPlayers[query.message.message_id].includes(query.from.username)) {
          cuefaColl[query.message.message_id].player1[query.from.username].select = cuefaToEmoji[query.data];
          cuefaColl[query.message.message_id].steps.player1Step = true;
          cuefaPlayer1Id[query.message.message_id] = query.from.id;
  
          if (!cuefaColl[query.message.message_id].steps.player2Step) {
            bot.editMessageText(
              `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
@${cuefaPlayers[query.message.message_id][0]} üëç üÜö ${player2Name}`,
              {
                chat_id: query.message.chat.id,
                message_id: query.message.message_id,
                reply_markup: cuefaKeyboard,
              }
            );
          }
        } else {
          bot.answerCallbackQuery(query.id, {
            text: "–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —Ö–æ–¥, –∂–¥–∏ —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!",
          });
        } //–µ—Å–ª–∏ —É –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–µ –±—ã–ª–æ —Ö–æ–¥–∞, —Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞—é —Ö–æ–¥
      } else if (cuefaPlayers[query.message.message_id][1] == "undefined") {
        const newPlayer = {};
        newPlayer[query.from.username] = { select: cuefaToEmoji[query.data] };
        cuefaColl[query.message.message_id].player2 = newPlayer;
        cuefaColl[query.message.message_id].steps.player2Step = true;
        cuefaPlayers[query.message.message_id][1] = query.from.username;
        cuefaPlayer2Id[query.message.message_id] = query.from.id;
  
        if (!cuefaColl[query.message.message_id].steps.player1Step) {
          bot.editMessageText(
            `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
@${cuefaPlayers[query.message.message_id][0]} üÜö üëç @${cuefaPlayers[query.message.message_id][1]}`,
            {
              chat_id: query.message.chat.id,
              message_id: query.message.message_id,
              reply_markup: cuefaKeyboard,
            }
          );
        }
      } else if (cuefaPlayers[query.message.message_id][1] == query.from.username) {
        if (!cuefaColl[query.message.message_id].steps.player2Step) {
  
          cuefaColl[query.message.message_id].player2[query.from.username].select = cuefaToEmoji[query.data];
          cuefaColl[query.message.message_id].steps.player2Step = true;
          cuefaPlayer2Id[query.message.message_id] = query.from.id;
  
          if (!cuefaColl[query.message.message_id].steps.player1Step) {
            bot.editMessageText(
              `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
@${cuefaPlayers[query.message.message_id][0]} üÜö üëç ${player2Name}`,
              {
                chat_id: query.message.chat.id,
                message_id: query.message.message_id,
                reply_markup: cuefaKeyboard,
              }
            );
          }
        } else {
          bot.answerCallbackQuery(query.id, {
            text: "–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —Ö–æ–¥, –∂–¥–∏ —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!",
          });
        }
      } else {
        bot.answerCallbackQuery(query.id, {
          text: "–≠—Ç–∞ —Å–µ—Å—Å–∏—è –Ω–µ –¥–ª—è —Ç–µ–±—è :( –°–æ–∑–¥–∞–π –Ω–æ–≤—É—é!",
        });
      }
  
      if (
        cuefaColl[query.message.message_id].steps.player1Step &&
        cuefaColl[query.message.message_id].steps.player2Step
      ) {
        const step1 =
          cuefaColl[query.message.message_id].player1[cuefaPlayers[query.message.message_id][0]].select;
        const step2 =
          cuefaColl[query.message.message_id].player2[cuefaPlayers[query.message.message_id][1]].select;
        let winner;
  
        let winName;
        let winId;
        let loseName;
        let loseId;
        let noWin = false;
  
        if (step1 == "ü§ú" && step2 == "‚úåÔ∏è") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][0]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][0];
          winId = cuefaPlayer1Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][1];
          loseId = cuefaPlayer2Id[query.message.message_id];
        }
  
        if (step1 == "ü§ú" && step2 == "‚úã") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][1]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][1];
          winId = cuefaPlayer2Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][0];
          loseId = cuefaPlayer1Id[query.message.message_id];
        }
  
        if (step1 == "‚úåÔ∏è" && step2 == "‚úã") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][0]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][0];
          winId = cuefaPlayer1Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][1];
          loseId = cuefaPlayer2Id[query.message.message_id];
        }
  
        if (step1 == "‚úåÔ∏è" && step2 == "ü§ú") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][1]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][1];
          winId = cuefaPlayer2Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][0];
          loseId = cuefaPlayer1Id[query.message.message_id];
        }
  
        if (step1 == "‚úã" && step2 == "‚úåÔ∏è") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][1]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][1];
          winId = cuefaPlayer2Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][0];
          loseId = cuefaPlayer1Id[query.message.message_id];
        }
  
        if (step1 == "‚úã" && step2 == "ü§ú") {
          winner = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å - @${cuefaPlayers[query.message.message_id][0]} üèÜ`;
          winName = cuefaPlayers[query.message.message_id][0];
          winId = cuefaPlayer1Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][1];
          loseId = cuefaPlayer2Id[query.message.message_id];
        }
  
        if (step1 == step2) {
          winner = `–ù–∏—á—å—è ü§ù`
          winName = cuefaPlayers[query.message.message_id][0];
          winId = cuefaPlayer1Id[query.message.message_id];
          loseName = cuefaPlayers[query.message.message_id][1];
          loseId = cuefaPlayer2Id[query.message.message_id];
          noWin = true;
        }
  
        if (cuefaPlayer1Id[query.message.message_id] == cuefaPlayer2Id[query.message.message_id]) {
          bot.editMessageText(
            `–û—à–∏–±–∫–∞!`,
            {
              chat_id: query.message.chat.id,
              message_id: query.message.message_id,
              reply_markup: {
                inline_keyboard: [[{ text: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å üîÑ", callback_data: "cuefaReplay" }]]
              }
            }
          ).then(() => {
            delete cuefaColl[query.message.message_id];
            delete cuefaPlayers[query.message.message_id];
          });
  
          return;
        }
  
        if (isMeme) {//–µ—Å–ª–∏ —á–∞—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π
          setCuefaStats(String(winId), winName, String(loseId), loseName, noWin, () => {
            fs.readFile("../../cuefaStats.json", "UTF-8", (err, data) => {
              let stats = JSON.parse(data);
  
              bot.editMessageText(
                `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
@${cuefaPlayers[query.message.message_id][0]} ${step1} üÜö ${step2} @${cuefaPlayers[query.message.message_id][1]}
  
${winner}
  
@${stats[String(cuefaPlayer1Id[query.message.message_id])].name}: ${stats[String(cuefaPlayer1Id[query.message.message_id])].vs[String(cuefaPlayer2Id[query.message.message_id])][0]}
@${stats[String(cuefaPlayer2Id[query.message.message_id])].name}: ${stats[String(cuefaPlayer2Id[query.message.message_id])].vs[String(cuefaPlayer1Id[query.message.message_id])][0]}`,
                {
                  chat_id: query.message.chat.id,
                  message_id: query.message.message_id,
                  reply_markup: {
                    inline_keyboard: [[{ text: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å üîÑ", callback_data: "cuefaReplay" }]]
                  }
                }
              ).then(() => {
                setTimeout(() => {
                  delete cuefaColl[query.message.message_id];
                  delete cuefaPlayers[query.message.message_id];
                  delete cuefaPlayer1Id[query.message.message_id];
                  delete cuefaPlayer2Id[query.message.message_id];
                }, 5000);
              });
            });
          });
        } else { //–µ—Å–ª–∏ —á–∞—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º
          bot.editMessageText(
            `–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞
  @${cuefaPlayers[query.message.message_id][0]} ${step1} üÜö ${step2} @${cuefaPlayers[query.message.message_id][1]}
  
  ${winner}`,
            {
              chat_id: query.message.chat.id,
              message_id: query.message.message_id,
              reply_markup: {
                inline_keyboard: [[{ text: "–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–≥—Ä—ã", url: "meme_house_chat.t.me" }]]
              }
            }
          ).then(() => {
            setTimeout(() => {
              delete cuefaColl[query.message.message_id];
              delete cuefaPlayers[query.message.message_id];
              delete cuefaPlayer1Id[query.message.message_id];
              delete cuefaPlayer2Id[query.message.message_id];
            }, 5000);
          });
        }
  
      }
    }
  };

  module.exports = cuefaGame;